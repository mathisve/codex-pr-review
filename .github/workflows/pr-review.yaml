name: Perform a code review when a pull request is created.

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, labeled]

jobs:
  codex:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    if: |
      (github.event.action == 'labeled' && github.event.label.name == 'codex-review') ||
      (github.event.action == 'opened' && contains(toJSON(github.event.pull_request.labels), '"name":"codex-review"'))
    permissions:
      contents: read
    outputs:
      final_message: ${{ steps.run_codex.outputs.final-message }}
    steps:
      - uses: actions/checkout@v5
        with:
          # Explicitly check out the PR's merge commit.
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Pre-fetch base and head refs for the PR
        run: |
          git fetch --no-tags origin \
            ${{ github.event.pull_request.base.ref }} \
            +refs/pull/${{ github.event.pull_request.number }}/head

      # If you want Codex to build and run code, install any dependencies that
      # need to be downloaded before the "Run Codex" step because Codex's
      # default sandbox disables network access.

      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        timeout-minutes: 30
        continue-on-error: true
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            This is PR #${{ github.event.pull_request.number }} for ${{ github.repository }}.

            Review ONLY the changes introduced by this PR. You have the repo checked out; use the workspace to read the code.
            Run `git diff ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}` to see the exact diff, and read any changed or relevant files as needed.

            Suggest any improvements, potential bugs, or issues.
            Be concise and specific in your feedback.

            Write the PR review in Markdown format.

            Pull request title and body:
            ----
            ${{ github.event.pull_request.title }}
            ${{ github.event.pull_request.body }}

  post_feedback:
    runs-on: ubuntu-latest
    needs: codex
    if: always() && needs.codex.result != 'skipped'
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Report Codex feedback
        uses: actions/github-script@v7
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.codex.outputs.final_message }}
        with:
          github-token: ${{ github.token }}
          script: |
            const fallback =
              'Codex review did not finish before timeout or returned no message.';
            const body = (process.env.CODEX_FINAL_MESSAGE || '').trim() || fallback;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });